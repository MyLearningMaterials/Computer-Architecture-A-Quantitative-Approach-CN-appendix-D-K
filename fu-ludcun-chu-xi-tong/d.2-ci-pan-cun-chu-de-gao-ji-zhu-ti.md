# D.2 磁盘存储的高级主题

磁盘行业历来专注于提高磁盘的容量。

容量的提高通常用面密度的提高来表示，面密度以每平方英寸的位数来衡量:

<figure><img src="../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

大约到1988年，面积密度的改善速度为每年29%，即每3年密度翻一番。从那时到大约1996年，速度提高到每年60%，每3年密度翻四倍，与传统的dram速度相当。从1997年到2003年左右，这一比例增加到100%，每年都翻一番。在缔造这种复兴的创新之后，这一比率最近下降到每年30%左右。2011年，商业产品的最高密度是每平方英寸4000亿个比特。每千兆字节成本的下降速度至少与面密度的增加速度一样快，更小直径的驱动器在这一改进中发挥了更大的作用。从1983年到2011年，每千兆字节的成本几乎提高了100万倍。

磁盘作为二级存储器的霸主地位已多次受到挑战。图D.1显示了一个原因:磁盘和DRAM之间的访问时间差距。DRAM的延迟比磁盘大约少10万倍，而这种性能优势每千兆字节的成本是DRAM的30到150倍。

<figure><img src="../.gitbook/assets/image (1).png" alt=""><figcaption><p>图D.1 1980年、1985年、1990年、1995年、2000年和2005年DRAM和磁盘的成本与访问时间的关系。半导体存储器和旋转磁盘在成本上的两个数量级的差距和访问时间上的五个数量级的差距激发了许多相互竞争的技术来试图填补它们。到目前为止，由于磁盘、dram或两者的改进，这种尝试在生产之前就已经过时了。请注意，从1990年到2005年，每千兆字节DRAM芯片的成本几乎没有提高，而磁盘成本却有了显著提高。</p></figcaption></figure>

带宽差距更为复杂。例如，2011年的来自磁盘媒体的快速磁盘的传输速度为200mb /秒，存储空间为600gb，价格约为400美元。2011年，一个价值200美元的4gb DRAM可以以16000 MB/秒的速度传输(见第二章)，这使得DRAM的带宽比磁盘高80倍。但是，磁盘每GB的带宽是DRAM的6000倍，每美元的带宽是DRAM的160倍。

许多人试图发明一种比DRAM更便宜但比磁盘更快的技术来填补这一空白，但到目前为止，所有人都失败了。挑战者们一直以来都没能在合适的时间推出他们的产品。每当一种新产品上市时，DRAM和磁盘已经像之前预测的那样取得了进步，成本也相应下降，具有挑战性的产品立即被淘汰。

最接近的挑战者是闪存。这种半导体存储器和磁盘一样是非易失性的，它的带宽和磁盘差不多，但是延迟比磁盘快100到1000倍。2011年，每GB闪存的价格比DRAM便宜15到20倍。闪存在手机中很受欢迎，因为它的容量小得多，而且比磁盘更节能，尽管每千兆字节的成本比磁盘高15到25倍。与磁盘和DRAM不同，闪存的比特会磨损，通常只能写100万次，因此它们在台式电脑和服务器电脑中并不流行。

尽管在可预见的未来，磁盘仍然会保留，但传统的扇区-轨道-圆柱体模式已不复存在。该模型的假设是邻近的块在同一轨道上，同一圆柱体中的块由于不需要寻道所以访问花费的时间较少，并且离圆柱体轴更近的轨道能更快地被访问到。

首先，磁盘开始提供更高级别的智能接口，如ATA和SCSI，它们在磁盘中嵌入了一个微处理器。为了加速顺序传输，这些高级接口将磁盘组织得更像磁带，而不是随机访问设备。逻辑块在单个表面上以蛇形排列，试图捕获以相同位密度记录的所有扇区。(由于电子设备很难跟上旋转速度快得多的外部轨道，磁盘表面的记录密度（recording density）并不均匀，然后，降低线性密度简化了任务)因此，顺序块可能在不同的轨道上。稍后，我们将在图D.22中看到，在使用现代磁盘时，使用传统扇区磁道模型是错误的。

其次，在人们把微处理器嵌入磁盘后不久，磁盘就有了缓冲区，用于保存数据，直到计算机准备来读取，后来还包含了缓存，以避免读访问。它们由一个命令队列连接，该队列允许磁盘决定以何种顺序执行命令，以在保持正确行为的同时最大化性能。图D.2显示了队列深度为50时，由于更好的访问调度，每秒发生随机I/O的数量可以增加一倍。虽然系统不太可能在一个队列中真正拥有256个命令，但这会使每秒的I/O数量增加三倍。给定缓冲区、缓存和乱序访问，真实磁盘的精确性能模型要比扇区-磁道-柱面复杂得多。

<figure><img src="../.gitbook/assets/image (2).png" alt=""><figcaption><p>图D.2 使用随机512byte读取时吞吐量与命令队列深度的关系。磁盘在没有命令队列的情况下每秒执行170次读取，在50次时执行两倍，在256次时执行三倍[Anderson 2003]</p></figcaption></figure>

最后，盘片的数量从过去的12个减少到今天的4个甚至1个，因此圆柱体的重要性不如以前，因为圆柱体中的数据百分比要小得多。

## 磁盘的功耗

对于磁盘和处理器来说，功率是一个越来越重要的问题。2011年的典型ATA磁盘在空闲时可能使用9瓦，读写时使用11瓦，查找时使用13瓦。因为旋转质量越小（质量越小，旋转就更快——译者注），效率越高，所以直径越小的圆盘可以节省电力。表明转速和盘片大小对磁盘电机消耗的功率的重要性的一个公式如下\[Gurumurthi et al . 2005]:

<figure><img src="../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

因此，更小的盘片、更慢的旋转和更少的盘片都有助于降低磁盘电机的功率，而大部分功率都被电机消耗掉了。

2个3.5英寸硬盘在2011年的整机规格如图D.3所示。串行ATA (SATA)磁盘具有高容量和每千兆字节的最佳成本，因此2000GB驱动器的成本低于每千兆字节0.05美元。他们使用最宽的盘片来适应外形因素，并且使用四五个盘片，但是他们以5900转/分钟的速度旋转，并且寻求相对缓慢的速度，以允许更高的面密度和更低的功率。相应的串行附加SCSI (SAS)驱动器以性能为目标，因此它以15,000 RPM旋转，并寻求更快的速度。它使用较低的面密度以如此高的速度旋转。为了降低功耗，盘片比外形尺寸窄得多。这种组合将SAS驱动器的容量减少到600GB。

<figure><img src="../.gitbook/assets/image (4).png" alt=""><figcaption><p>图D.3 2011年3.5英寸外形的串行ATA (SATA)与串行附加SCSI (SAS)驱动器对比图。每秒的I/O是用平均寻时间加上半轮的时间加上传输一个512 KB扇区的时间来计算的</p></figcaption></figure>

SATA驱动器的每千兆字节成本大约是SAS驱动器的五倍，相反，SAS驱动器的每秒每I/O或每秒传输MB的成本大约是SATA驱动器的五倍。尽管使用更小的盘片和更少的盘片，SAS磁盘使用的功率是SATA驱动器的两倍，因为RPM和寻道要快得多。

## 磁盘阵列的高级主题

磁盘阵列是提高存储系统可靠性和性能的一项创新。支持阵列的一个理由是，通过使用许多磁盘驱动器和磁盘臂，而不是使用更少的大型驱动器，可以增加潜在的吞吐量。简单地将数据分散到多个磁盘上，称为条带化（striping），如果数据文件很大，则自动强制访问多个磁盘。(虽然数组提高了吞吐量，但延迟并不一定会改善。)正如我们在第1章中看到的，缺点是设备越多，可靠性就越低:N个设备的可靠性通常是单个设备的1/N。

虽然在每个磁盘具有相同可靠性的情况下，磁盘阵列的故障数量会比数量较少的较大磁盘多，但通过向阵列中添加冗余磁盘以容错，可以提高可靠性。也就是说，如果单个磁盘出现故障，则可以从冗余信息中重建丢失的信息。唯一的危险是在平均修复时间(MTTR)期间另一个磁盘出现故障。由于磁盘的平均无故障时间(MTTF)为几十年，而MTTR以小时为单位进行测量，因此**冗余可以使多个磁盘的测量可靠性远远高于单个磁盘的可靠性。**

这种冗余磁盘阵列的首字母缩写为RAID，它最初表示廉价磁盘的冗余阵列，尽管有些人更喜欢用独立这个词来代替首字母缩写中的I。从故障中恢复的能力以及更高的吞吐量(以每秒兆字节数或每秒I/O数衡量)使RAID具有很大的吸引力。再加上小直径驱动器体积更小、功耗更低的优点，RAID现在大型存储系统中占据主导地位。

图D.4总结了5种标准的RAID级别，并表明了每个RAID级别必须有8块存储用户数据的硬盘进行冗余或校验，然后列出了每种RAID级别的优缺点。标准RAID级别都有详细的文档记录，因此我们在这里只快速回顾一下，并更深入地讨论高级级别。
