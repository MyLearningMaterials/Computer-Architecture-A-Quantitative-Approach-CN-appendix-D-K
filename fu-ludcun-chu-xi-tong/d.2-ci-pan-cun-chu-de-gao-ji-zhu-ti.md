# D.2 磁盘存储的高级主题

磁盘行业历来专注于提高磁盘的容量。

容量的提高通常用面密度的提高来表示，面密度以每平方英寸的位数来衡量:

<figure><img src="../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

大约到1988年，面积密度的改善速度为每年29%，即每3年密度翻一番。从那时到大约1996年，速度提高到每年60%，每3年密度翻四倍，与传统的dram速度相当。从1997年到2003年左右，这一比例增加到100%，每年都翻一番。在缔造这种复兴的创新之后，这一比率最近下降到每年30%左右。2011年，商业产品的最高密度是每平方英寸4000亿个比特。每千兆字节成本的下降速度至少与面密度的增加速度一样快，更小直径的驱动器在这一改进中发挥了更大的作用。从1983年到2011年，每千兆字节的成本几乎提高了100万倍。

磁盘作为二级存储器的霸主地位已多次受到挑战。图D.1显示了一个原因:磁盘和DRAM之间的访问时间差距。DRAM的延迟比磁盘大约少10万倍，而这种性能优势每千兆字节的成本是DRAM的30到150倍。

<figure><img src="../.gitbook/assets/image (1) (1).png" alt=""><figcaption><p>图D.1 1980年、1985年、1990年、1995年、2000年和2005年DRAM和磁盘的成本与访问时间的关系。半导体存储器和旋转磁盘在成本上的两个数量级的差距和访问时间上的五个数量级的差距激发了许多相互竞争的技术来试图填补它们。到目前为止，由于磁盘、dram或两者的改进，这种尝试在生产之前就已经过时了。请注意，从1990年到2005年，每千兆字节DRAM芯片的成本几乎没有提高，而磁盘成本却有了显著提高。</p></figcaption></figure>

带宽差距更为复杂。例如，2011年的来自磁盘媒体的快速磁盘的传输速度为200mb /秒，存储空间为600gb，价格约为400美元。2011年，一个价值200美元的4gb DRAM可以以16000 MB/秒的速度传输(见第二章)，这使得DRAM的带宽比磁盘高80倍。但是，磁盘每GB的带宽是DRAM的6000倍，每美元的带宽是DRAM的160倍。

许多人试图发明一种比DRAM更便宜但比磁盘更快的技术来填补这一空白，但到目前为止，所有人都失败了。挑战者们一直以来都没能在合适的时间推出他们的产品。每当一种新产品上市时，DRAM和磁盘已经像之前预测的那样取得了进步，成本也相应下降，具有挑战性的产品立即被淘汰。

最接近的挑战者是闪存。这种半导体存储器和磁盘一样是非易失性的，它的带宽和磁盘差不多，但是延迟比磁盘快100到1000倍。2011年，每GB闪存的价格比DRAM便宜15到20倍。闪存在手机中很受欢迎，因为它的容量小得多，而且比磁盘更节能，尽管每千兆字节的成本比磁盘高15到25倍。与磁盘和DRAM不同，闪存的比特会磨损，通常只能写100万次，因此它们在台式电脑和服务器电脑中并不流行。

尽管在可预见的未来，磁盘仍然会保留，但传统的扇区-轨道-圆柱体模式已不复存在。该模型的假设是邻近的块在同一轨道上，同一圆柱体中的块由于不需要寻道所以访问花费的时间较少，并且离圆柱体轴更近的轨道能更快地被访问到。

首先，磁盘开始提供更高级别的智能接口，如ATA和SCSI，它们在磁盘中嵌入了一个微处理器。为了加速顺序传输，这些高级接口将磁盘组织得更像磁带，而不是随机访问设备。逻辑块在单个表面上以蛇形排列，试图捕获以相同位密度记录的所有扇区。(由于电子设备很难跟上旋转速度快得多的外部轨道，磁盘表面的记录密度（recording density）并不均匀，然后，降低线性密度简化了任务)因此，顺序块可能在不同的轨道上。稍后，我们将在图D.22中看到，在使用现代磁盘时，使用传统扇区磁道模型是错误的。

其次，在人们把微处理器嵌入磁盘后不久，磁盘就有了缓冲区，用于保存数据，直到计算机准备来读取，后来还包含了缓存，以避免读访问。它们由一个命令队列连接，该队列允许磁盘决定以何种顺序执行命令，以在保持正确行为的同时最大化性能。图D.2显示了队列深度为50时，由于更好的访问调度，每秒发生随机I/O的数量可以增加一倍。虽然系统不太可能在一个队列中真正拥有256个命令，但这会使每秒的I/O数量增加三倍。给定缓冲区、缓存和乱序访问，真实磁盘的精确性能模型要比扇区-磁道-柱面复杂得多。

<figure><img src="../.gitbook/assets/image (2).png" alt=""><figcaption><p>图D.2 使用随机512byte读取时吞吐量与命令队列深度的关系。磁盘在没有命令队列的情况下每秒执行170次读取，在50次时执行两倍，在256次时执行三倍[Anderson 2003]</p></figcaption></figure>

最后，盘片的数量从过去的12个减少到今天的4个甚至1个，因此圆柱体的重要性不如以前，因为圆柱体中的数据百分比要小得多。

## 磁盘的功耗

对于磁盘和处理器来说，功率是一个越来越重要的问题。2011年的典型ATA磁盘在空闲时可能使用9瓦，读写时使用11瓦，查找时使用13瓦。因为旋转质量越小（质量越小，旋转就更快——译者注），效率越高，所以直径越小的圆盘可以节省电力。表明转速和盘片大小对磁盘电机消耗的功率的重要性的一个公式如下\[Gurumurthi et al . 2005]:

<figure><img src="../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

因此，更小的盘片、更慢的旋转和更少的盘片都有助于降低磁盘电机的功率，而大部分功率都被电机消耗掉了。

2个3.5英寸硬盘在2011年的整机规格如图D.3所示。串行ATA (SATA)磁盘具有高容量和每千兆字节的最佳成本，因此2000GB驱动器的成本低于每千兆字节0.05美元。他们使用最宽的盘片来适应外形因素，并且使用四五个盘片，但是他们以5900转/分钟的速度旋转，并且寻求相对缓慢的速度，以允许更高的面密度和更低的功率。相应的串行附加SCSI (SAS)驱动器以性能为目标，因此它以15,000 RPM旋转，并寻求更快的速度。它使用较低的面密度以如此高的速度旋转。为了降低功耗，盘片比外形尺寸窄得多。这种组合将SAS驱动器的容量减少到600GB。

<figure><img src="../.gitbook/assets/image (4).png" alt=""><figcaption><p>图D.3 2011年3.5英寸外形的串行ATA (SATA)与串行附加SCSI (SAS)驱动器对比图。每秒的I/O是用平均寻时间加上半轮的时间加上传输一个512 KB扇区的时间来计算的</p></figcaption></figure>

SATA驱动器的每千兆字节成本大约是SAS驱动器的五倍，相反，SAS驱动器的每秒每I/O或每秒传输MB的成本大约是SATA驱动器的五倍。尽管使用更小的盘片和更少的盘片，SAS磁盘使用的功率是SATA驱动器的两倍，因为RPM和寻道要快得多。

## 磁盘阵列的高级主题

磁盘阵列是提高存储系统可靠性和性能的一项创新。支持阵列的一个理由是，通过使用许多磁盘驱动器和磁盘臂，而不是使用更少的大型驱动器，可以增加潜在的吞吐量。简单地将数据分散到多个磁盘上，称为条带化（striping），如果数据文件很大，则自动强制访问多个磁盘。(虽然数组提高了吞吐量，但延迟并不一定会改善。)正如我们在第1章中看到的，缺点是设备越多，可靠性就越低:N个设备的可靠性通常是单个设备的1/N。

虽然在每个磁盘具有相同可靠性的情况下，磁盘阵列的故障数量会比数量较少的较大磁盘多，但通过向阵列中添加冗余磁盘以容错，可以提高可靠性。也就是说，如果单个磁盘出现故障，则可以从冗余信息中重建丢失的信息。唯一的危险是在平均修复时间(MTTR)期间另一个磁盘出现故障。由于磁盘的平均无故障时间(MTTF)为几十年，而MTTR以小时为单位进行测量，因此**冗余可以使多个磁盘的测量可靠性远远高于单个磁盘的可靠性。**

这种冗余磁盘阵列的首字母缩写为RAID，它最初表示廉价磁盘的冗余阵列，尽管有些人更喜欢用独立这个词来代替首字母缩写中的I。从故障中恢复的能力以及更高的吞吐量(以每秒兆字节数或每秒I/O数衡量)使RAID具有很大的吸引力。再加上小直径驱动器体积更小、功耗更低的优点，RAID现在大型存储系统中占据主导地位。

图D.4总结了5种标准的RAID级别，并表明了每个RAID级别必须有8块存储用户数据的硬盘进行冗余或校验，然后列出了每种RAID级别的优缺点。标准RAID级别都有详细的文档记录，因此我们在这里只快速回顾一下，并更深入地讨论高级级别。

* RAID0——它没有冗余，有时被昵称为JBOD，仅用于一堆磁盘，尽管数据可能在阵列中的磁盘上呈条纹状分布。这个级别通常作为其他RAID级别在成本、性能和可靠性方面的衡量标准。
* RAID1——也称为镜像（mirroring）或阴影（shadowing），每个数据块都有两个副本。它是最简单、最古老的磁盘冗余方案，但成本也最高。有些阵列控制器会通过允许镜像磁盘独立执行读操作来优化读性能，但这种优化意味着镜像写操作可能需要更长的时间才能完成。
* RAID2——该组织的灵感来自于将内存风格的纠错码(ecc)应用于磁盘。之所以包括它，是因为在最初的RAID论文中有这样一种磁盘阵列产品，但之后就没有了，因为其他RAID组织更有吸引力。
* RAID3——由于可以通过高级磁盘接口了解磁盘的使用情况，因此很容易确定哪个磁盘发生了故障。设计师们意识到，如果一个额外的磁盘包含数据磁盘中信息的奇偶校验，那么单个磁盘就能从磁盘故障中恢复。数据按条组织，有N个数据块和一个奇偶校验块。当发生故障时，我们只是从好的块中“减去”好的数据，剩下的就是缺失的数据(无论故障盘是数据盘还是校验盘，这种方法都有效)。RAID3假定在读写时数据分布在所有磁盘上，这在读写大量数据时很有用。
* RAID4——许多应用程序都是由轻量级的访问控制的。由于扇区会进行自己的错误检查，因此可以通过允许每个磁盘执行独立的读取来安全地增加每秒的读取次数。如果坚持读取每个磁盘来计算奇偶校验，那么写操作仍然会很慢。为了增加每秒的写次数，另一种方法只涉及两个磁盘。首先，阵列读取即将被覆盖的旧数据，然后计算在写入新数据之前会改变哪些位。然后，它读取校验磁盘上奇偶校验的旧值，根据更改操作的列表更新奇偶校验值，然后将新的奇偶校验值写入校验磁盘。因此，这些所谓的“轻量级的写操作”仍然比轻量级的读操作慢——它们涉及4个磁盘访问——但是也比“每次写都读取所有磁盘”快。RAID4具有与RAID3相同的低校验磁盘开销，并且除了轻量级的写操作之外，它仍然可以像RAID3一样快速地进行大规模的读写，但是控制更复杂。
* RAID5——注意，对于RAID4中的轻量级写操作，一个性能缺陷是它们都必须读取和写入相同的校验磁盘，因此这是一个性能瓶颈。RAID5通过在阵列中的所有磁盘上分发奇偶校验信息消除了瓶颈。每个条带中的奇偶校验块被旋转，以便奇偶校验均匀地分布在所有磁盘上。磁盘阵列控制器现在必须计算当它想要写入给定块时哪个磁盘具有奇偶校验，但这可以是一个简单的计算。RAID5具有与RAID3和RAID4相同的低校验磁盘开销，并且可以完成RAID3的大规模读写和RAID4的轻量级读取，但它具有比RAID4更高的轻量级写入带宽。然而，RAID5需要经典RAID级别中最复杂的控制器。

<figure><img src="../.gitbook/assets/image (5).png" alt=""><figcaption><p>图D.4 RAID级别、容错能力和冗余硬盘开销。介绍术语RAID的论文[Patterson, Gibson, and Katz 1987]使用了一种流行的数字分类。实际上，非冗余磁盘阵列通常被称为RAID0，这表明数据在多个磁盘上分条存储，但没有冗余。请注意，在此实例中，镜像(RAID1)最多可以支持8个磁盘故障，前提是每个镜像对中只有一个磁盘故障;最坏的情况是镜像对中的两个磁盘都故障。在2011年，可能没有RAID2的商业实现;其余的存在于各种各样的产品中。本文主要讨论RAID 0+ 1、1 + 0、01、10和6。</p></figcaption></figure>

#### RAID 10 vs 01(或1 +0 vs RAID 0+1)

RAID文献中并不总有的一个主题是RAID1中的镜像如何与条带化相互作用。假设您有4个磁盘的数据要存储，8个物理磁盘要使用。您是否会创建四对磁盘(每个磁盘组织为RAID1)，然后在四对RAID1中分条存储数据?或者，您是否创建两组4个磁盘(每个磁盘组织为RAID0)，然后镜像写入两个RAID0集？现在的RAID术语将前者称为RAID 1 + 0或RAID 10(“条纹镜像”)，将后者称为RAID 0 + 1或RAID 01(“镜像条纹”)。

#### RAID 6:超越单个磁盘故障

RAID1到RAID5基于奇偶校验的方案可以防止单个自识别故障;但是，如果操作人员在故障期间不小心更换了错误的磁盘，则磁盘阵列将经历两次故障，并且数据将丢失。另一个问题是，由于磁盘带宽的增长速度比磁盘容量的增长速度慢，因此RAID系统中磁盘的MTTR正在增加，这反过来又增加了第二次故障的可能性。例如，假设没有干扰，一个500GB的SATA磁盘连续读取可能需要大约3小时。考虑到损坏的RAID可能会继续提供数据，重构可能会被拉长，从而增加MTTR。除了增加重构时间外，另一个问题是，在重构期间读取更多的数据意味着增加不可纠正介质故障的可能性，从而导致数据丢失。关注同时多重故障的其他论据是阵列中磁盘数量的增加和ATA磁盘的使用，因为ATA磁盘比SCSI磁盘更慢、更大。

因此，多年来，人们对防止多种故障的兴趣越来越大。例如，网络设备(NetApp)从构建RAID4文件服务器开始。由于双重故障对客户的威胁，他们创建了一个更强大的方案来保护数据，称为行对角线奇偶校验或RAID-DP \[Corbett et al . 2004]。与标准RAID方案一样，行对角线奇偶校验基于每个条带的奇偶计算使用冗余空间。由于它防止双重故障，因此它为每个数据条添加两个检查块。假设总共有p+1个磁盘，所以p-1个磁盘有数据。图D.5为p = 5时的情况。

<figure><img src="../.gitbook/assets/image (6).png" alt=""><figcaption><p>图D.5 p=5的行对角奇偶校验，它保护了四个数据磁盘免于双重故障[Corbett et al . 2004]。该图显示了计算奇偶校验并存储在对角奇偶磁盘中的对角组。虽然这在单独的磁盘中显示了行奇偶校验和对角奇偶校验的所有校验数据，就像在RAID4中一样，但是有一个类似于RAID5的行对角奇偶校验的旋转版本。参数p必须是素数且大于2；但是，您可以假设缺失的磁盘全部为零，从而使p大于数据磁盘的数量，并且该方案仍然有效。这个技巧可以很容易地将磁盘添加到现有系统中。NetApp选择p为257，这允许系统扩展到最多256个数据磁盘。</p></figcaption></figure>

行奇偶校验磁盘就像RAID4；它包含其分条中其他四个数据块的偶数奇偶校验。对角线奇偶校验磁盘的每个块包含同一对角线上的块的偶奇偶校验。请注意，每个对角线都没有完整地覆盖一个磁盘；例如，对角线0不包括磁盘1。因此，我们只需要p-1条对角线来保护p个磁盘，因此在图D.5中磁盘只有0到3条对角线。

假设数据磁盘1和3在图D.5中出现故障，让我们看看行对角线奇偶校验是如何工作的。使用行奇偶校验，我们不能使用行奇偶校验来对第一行执行标准RAID恢复，因为它缺少磁盘1和3中的两个数据块。但是，我们可以在对角线0上执行恢复，因为它只丢失与磁盘3关联的数据块。因此，在本例中，行对角奇偶首先使用对角奇偶恢复故障磁盘上的四个块中的一个。因为每条对角线都错过了一个磁盘，而所有对角线都错过了一个不同的磁盘，所以两条对角线只错过了一个块。在本例中，它们是对角线0和2，因此我们接下来从对角线2恢复故障磁盘1的数据块。当这些块的数据被恢复后，就可以使用标准的RAID恢复方案在标准RAID4的条带0和条带2中再恢复两个块，这反过来又允许我们恢复更多对角线。这个过程一直持续到两个故障磁盘完全恢复。

IBM研究人员早期开发的偶数-奇数方案类似于行对角线奇偶校验，但它在操作和恢复期间需要更多的计算\[Blaum 1995]。最近的一些论文展示了如何扩展偶数-奇数以防止三种失败\[Blaum, Bruck, and Vardy 1996;Blaum et al . 2001]。
